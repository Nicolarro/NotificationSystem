version: 2.1

jobs:
  build-backend:
    docker:
      - image: mcr.microsoft.com/dotnet/sdk:8.0
      - image: cimg/postgres:16.2
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: nilariver
          POSTGRES_DB: postgres
    environment:
      ConnectionStrings__DefaultConnection: "Host=127.0.0.1;Port=5432;Database=TakeHomeChallengeDB_Test;User Id=postgres;Password=nilariver;TrustServerCertificate=True;"
      ApiSettings__SecretKey: "Esta es una clave secreta y tiene que ser extensa para evitar error de encriptaciÃ³n"
    steps:
      - checkout
      - run:
          name: Wait for PostgreSQL
          command: |
            apt-get update -qq && apt-get install -y -qq postgresql-client > /dev/null
            until pg_isready -h 127.0.0.1 -p 5432 -U postgres; do
              echo "Waiting for PostgreSQL..."
              sleep 2
            done
            echo "PostgreSQL is ready!"
      - run:
          name: Restore dependencies
          command: |
            dotnet tool restore
            dotnet restore
      - run:
          name: Build
          command: dotnet build --configuration Release --no-restore
      - run:
          name: Install Python and Coveralls
          command: |
            apt-get update -qq && apt-get install -y -qq python3 python3-pip python3-venv
            python3 -m venv /tmp/venv
            /tmp/venv/bin/pip install --quiet coveralls
      - run:
          name: Run tests
          command: |
            dotnet test tests/TakeHomeChallenge.IntegrationTests/TakeHomeChallenge.IntegrationTests.csproj \
              --configuration Release \
              --no-build \
              --collect:"XPlat Code Coverage" \
              --results-directory tests/TakeHomeChallenge.IntegrationTests/coverage \
              -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=lcov
      - run:
          name: Debug coverage files
          command: |
            echo "=== Contents of coverage directory ==="
            find tests/TakeHomeChallenge.IntegrationTests/coverage -type f | head -20
            echo "=== Total files found ==="
            find tests/TakeHomeChallenge.IntegrationTests/coverage -type f | wc -l
            echo "=== Checking for coverage.info ==="
            find tests/TakeHomeChallenge.IntegrationTests/coverage -name "coverage.info" -type f
      - run:
          name: Upload to Coveralls
          command: |
            COVERAGE_FILE=$(find tests/TakeHomeChallenge.IntegrationTests/coverage -name "coverage.info" -type f | head -n 1)
            if [ -f "$COVERAGE_FILE" ]; then
              echo "Found coverage file: $COVERAGE_FILE"
              echo "File size: $(wc -c < "$COVERAGE_FILE") bytes"
              /tmp/venv/bin/coveralls --service=circleci < "$COVERAGE_FILE"
              echo "Upload completed with exit code: $?"
            else
              echo "Coverage file not found!"
              echo "Checking environment: COVERALLS_REPO_TOKEN=${COVERALLS_REPO_TOKEN:0:10}..."
              exit 1
            fi
      - store_artifacts:
          path: tests/TakeHomeChallenge.IntegrationTests/coverage
          destination: coverage

  build-frontend:
    docker:
      - image: cimg/node:18.16
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm ci
          working_directory: src/client
      - run:
          name: Build
          command: npm run build
          working_directory: src/client
      - run:
          name: Lint
          command: npm run lint
          working_directory: src/client

workflows:
  build_and_test:
    jobs:
      - build-backend
      - build-frontend
